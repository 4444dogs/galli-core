<html>

<video id="player" autoplay></video>
<iframe id="frame"></iframe>
<script>
    frame.src = new URLSearchParams(location.search).get('sub_frame');

    let resolveDeviceIdPromise;
    const deviceIdPromise = new Promise(a => resolveDeviceIdPromise = a);

    async function requestCapture(target) {
        brave.beginAdvertiseShareDisplayMedia(resolveDeviceIdPromise, target || window);
    }

    async function startCapture(deviceId) {
        try {
            const stream = await window.navigator.mediaDevices.getUserMedia({
                video: {
                    mandatory: {
                        chromeMediaSource: 'tab',
                        chromeMediaSourceId: deviceId
                    }
                }
            });

            player.srcObject = stream;
            return true;
        } catch {
            return false;
        }
    }

    async function delegateCaptureToFrame(deviceId) {
        frame.contentWindow.postMessage({
            deviceId
        }, '*');
    }
</script>

</html>