<html>
<video id="player" autoplay></video>
<iframe id="frame"></iframe>
<script>
    frame.src = new URLSearchParams(location.search).get('sub_frame');

    let lastDeviceId;
    let resolve;
    window.deviceIdPromise = new Promise(a => resolve = a);

    window.requestCapture = function requestCapture(target) {
        brave.beginAdvertiseShareDisplayMedia(deviceId => {
            lastDeviceId = deviceId;
            resolve(deviceId);
        }, target || window);
    }

    async function startCapture(deviceId) {
        const stream = await window.navigator.mediaDevices.getUserMedia({
            video: {
                mandatory: {
                    chromeMediaSource: 'tab',
                    chromeMediaSourceId: deviceId
                }
            }
        });

        player.srcObject = stream;
        return true;
    }

    async function delegateCaptureToFrame(deviceId) {
        frame.contentWindow.postMessage({
            deviceId
        });
    }
</script>

</html>